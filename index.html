
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carrito Manufharm</title>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2/dist/email.min.js"></script>
  <script>
    (function() {
      emailjs.init("zCSiSodo0VsHC4LbD");
    })();
  </script>
  <style>
    body { font-family: Arial; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #eee; }
    .btn { background: #007bff; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    .btn:hover { background: #0056b3; }
  </style>
</head>
<body>

<h2>Carrito de Compras Manufharm</h2>
<input type="text" id="buscar" placeholder="Buscar por descripción, EAN o interno" onkeyup="filtrar()"/>

<table id="tabla">
  <thead>
    <tr>
      <th>EAN</th><th>Interno</th><th>Descripción</th><th>Precio Neto</th><th>Vence</th><th>Cant.</th><th>Agregar</th>
    </tr>
  </thead>
  <tbody id="cuerpo"></tbody>
</table>

<h3>Carrito</h3>
<ul id="carrito"></ul>
<p>Total: $<span id="total">0</span></p>
<input type="text" id="cliente" placeholder="Nombre del cliente" />
<button class="btn" onclick="enviar()">Enviar Pedido</button>

<script>
let productos = [], carrito = [];

fetch("productos.json")
  .then(r => r.json())
  .then(data => {
    productos = data;
    render(data);
  });

function render(lista) {
  const cuerpo = document.getElementById("cuerpo");
  cuerpo.innerHTML = "";
  lista.forEach((p, i) => {
    if (p.descripcion && p.ean !== "EAN") {
      cuerpo.innerHTML += `
        <tr>
          <td>${p.ean}</td>
          <td>${p.interno}</td>
          <td>${p.descripcion}</td>
          <td>$${parseInt(p.neto)}</td>
          <td>${p.vence}</td>
          <td><input type="number" id="cant_${i}" value="1" min="1" style="width:50px"/></td>
          <td><button class="btn" onclick="add(${i})">Agregar</button></td>
        </tr>
      `;
    }
  });
}

function filtrar() {
  const q = document.getElementById("buscar").value.toLowerCase();
  const filtrados = productos.filter(p =>
    p.descripcion?.toLowerCase().includes(q) ||
    p.interno?.toLowerCase().includes(q) ||
    p.ean?.toString().includes(q)
  );
  render(filtrados);
}

function add(index) {
  const cant = parseInt(document.getElementById(`cant_${index}`).value);
  if (cant > 0) {
    const p = productos[index];
    carrito.push({ ...p, cantidad: cant });
    updateCarrito();
  }
}

function updateCarrito() {
  const ul = document.getElementById("carrito");
  const totalElem = document.getElementById("total");
  ul.innerHTML = "";
  let total = 0;
  carrito.forEach(p => {
    const li = document.createElement("li");
    const subtotal = p.neto * p.cantidad;
    total += subtotal;
    li.textContent = `${p.descripcion} x${p.cantidad} = $${subtotal}`;
    ul.appendChild(li);
  });
  totalElem.textContent = total;
}

function enviar() {
  const cliente = document.getElementById("cliente").value;
  if (!cliente || carrito.length === 0) {
    alert("Falta nombre del cliente o carrito vacío");
    return;
  }

  const detalle = carrito.map(p => `${p.descripcion} x${p.cantidad} = $${p.neto * p.cantidad}`).join("\n");
  const total = carrito.reduce((acc, p) => acc + p.neto * p.cantidad, 0);

  emailjs.send("service_q06m7o8", "template_z5a44ua", {
    client: cliente,
    message: detalle,
    total: total
  }).then(() => {
    alert("Pedido enviado");
    carrito = [];
    updateCarrito();
  }).catch(err => alert("Error al enviar: " + err));
}
</script>

</body>
</html>
