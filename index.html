
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Carrito de Pedidos - Manufharm</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { background-color: #f8f9fa; padding: 20px; }
    .carrito-box { background: #fff; padding: 20px; border: 1px solid #ddd; border-radius: 5px; margin-top: 30px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4">Cargar Productos desde Excel</h2>
    <input type="text" id="busqueda" placeholder="Buscar por nombre, código o EAN" class="form-control mb-3" onkeyup="filtrarTabla()">

    <table class="table table-bordered" id="tablaProductos">
      <thead class="table-light">
        <tr>
          <th>EAN</th>
          <th>Interno</th>
          <th>Descripción</th>
          <th>Precio Neto</th>
          <th>Vencimiento</th>
          <th>Cantidad</th>
          <th>Agregar</th>
        </tr>
      </thead>
      <tbody id="cuerpoTabla"></tbody>
    </table>

    <div class="carrito-box">
      <h5>Carrito de Pedido</h5>
      <ul id="listaCarrito" class="list-group mb-3"></ul>
      <h6 id="totalCarrito">Total: $0</h6>
      <button class="btn btn-success me-2" onclick="enviarPedido()">Enviar Pedido</button>
      <button class="btn btn-danger" onclick="vaciarCarrito()">Eliminar Todo</button>
    </div>
  </div>

<script>
let productos = [];
const carrito = [];

async function cargarDesdeExcel() {
  const url = "https://raw.githubusercontent.com/Zorropaton/carrito-manufharm/main/productos_compatibles%20(1).xlsx";
  const response = await fetch(url);
  const data = await response.arrayBuffer();
  const workbook = XLSX.read(data, { type: 'array' });
  const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
  productos = XLSX.utils.sheet_to_json(firstSheet);
  renderTabla();
}

function renderTabla() {
  const cuerpo = document.getElementById('cuerpoTabla');
  cuerpo.innerHTML = '';
  productos.forEach((p, i) => {
    const row = `<tr>
      <td>${p.ean}</td>
      <td>${p.interno}</td>
      <td>${p.descripcion}</td>
      <td>$${p.neto}</td>
      <td>${p.vence}</td>
      <td><input type='number' class='form-control' id='cant_${i}' value='1' min='1'></td>
      <td><button class='btn btn-primary btn-sm' onclick='agregar(${i})'>Agregar</button></td>
    </tr>`;
    cuerpo.innerHTML += row;
  });
}

function agregar(i) {
  const cant = parseInt(document.getElementById(`cant_${i}`).value);
  if (!cant || cant <= 0) return;
  const item = productos[i];
  const existente = carrito.find(p => p.interno === item.interno);
  if (existente) {
    existente.cantidad += cant;
  } else {
    carrito.push({ ...item, cantidad: cant });
  }
  renderCarrito();
}

function renderCarrito() {
  const lista = document.getElementById('listaCarrito');
  const total = document.getElementById('totalCarrito');
  lista.innerHTML = '';
  let sumaTotal = 0;
  carrito.forEach((p, index) => {
    const subtotal = p.cantidad * p.neto;
    sumaTotal += subtotal;
    const li = document.createElement('li');
    li.className = 'list-group-item d-flex justify-content-between align-items-center';
    li.innerHTML = `${p.descripcion} x${p.cantidad} (Total: $${subtotal}) <button class='btn btn-sm btn-outline-danger' onclick='eliminarProducto(${index})'>Eliminar</button>`;
    lista.appendChild(li);
  });
  total.textContent = `Total: $${sumaTotal}`;
}

function eliminarProducto(index) {
  carrito.splice(index, 1);
  renderCarrito();
}

function vaciarCarrito() {
  carrito.length = 0;
  renderCarrito();
}

function filtrarTabla() {
  const filtro = document.getElementById('busqueda').value.toLowerCase();
  const filas = document.querySelectorAll('#tablaProductos tbody tr');
  filas.forEach(fila => {
    const texto = fila.textContent.toLowerCase();
    fila.style.display = texto.includes(filtro) ? '' : 'none';
  });
}

function enviarPedido() {
  if (carrito.length === 0) {
    alert("El carrito está vacío");
    return;
  }

  let cuerpoCorreo = "Estimado el cliente,%0D%0A%0D%0ASu pedido es el siguiente:%0D%0A%0D%0A";
  let sumaTotal = 0;
  carrito.forEach(p => {
    const subtotal = p.cantidad * p.neto;
    sumaTotal += subtotal;
    cuerpoCorreo += `- ${p.descripcion} x${p.cantidad} (Total: $${subtotal})%0D%0A`;
  });
  cuerpoCorreo += `%0D%0ATotal general: $${sumaTotal}`;

  const mailto = `mailto:fmartinez.manufharm@gmail.com,contacto.manufharm@gmail.com,ehernandez.manufharm@gmail.com,quimico@manufharm.com?subject=Pedido%20Manufharm&body=${cuerpoCorreo}`;
  window.location.href = mailto;
}

window.onload = cargarDesdeExcel;
</script>
</body>
</html>
